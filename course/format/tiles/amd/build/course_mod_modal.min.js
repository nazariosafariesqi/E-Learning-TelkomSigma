/**
 * Javascript Module to handle rendering of course modules (e.g. resource/PDF, resource/html, page) in modal windows
 *
 * When the user clicks a PDF course module subtile or old style resource
 * if we are using modals for it (e.g. PDF) , create, populate, launch and size the modal
 *
 * @module      format_tiles/course_mod_modal
 * @copyright   2018 David Watson {@link http://evolutioncode.uk}
 * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @since       Moodle 3.3
 */
define("format_tiles/course_mod_modal",["jquery","core/modal_factory","core/config","core/templates","core/notification","core/ajax"],(function($,modalFactory,config,Templates,Notification,ajax){var loadingIconHtml,courseId,modalStore={},win=$(window),Selector_completioncheckbox=".completioncheckbox",Selector_completionAuto=".completion-auto",Selector_modal=".modal",Selector_modalDialog=".modal-dialog",Selector_modalBody=".modal-body",Selector_sectionMain=".section.main",Selector_pageContent="#page-content",Selector_regionMain="#region-main",Selector_cmModal=".embed_cm_modal",Selector_moodleMediaPlayer=".mediaplugin_videojs",Selector_closeBtn="button.close",Selector_ACTIVITY="li.activity",Selector_URLACTIVITYPOPUPLINK=".activity.modtype_url.urlpopup a",Selector_newWindowButton=".button_expand",Selector_modalHeader=".modal-header",Selector_embedModuleButtons=".embed-module-buttons",Selector_iframe="iframe";const CLASS_COMPLETION_MANUAL="completeonmanual",CLASS_COMPLETION_AUTO="completion-auto";var LaunchModalDataActions={launchResourceModal:"launch-tiles-resource-modal",launchModuleModal:"launch-tiles-module-modal",launchUrlModal:"launch-tiles-url-modal"},modalMinWidth=function(){return Math.min(win.width(),1100)},stopAllVideosOnDismiss=function(modal){modal.find(Selector_iframe).length>0&&modal.find(Selector_closeBtn).click((function(e){$(e.currentTarget).closest(Selector_cmModal).find(Selector_iframe).each((function(index,iframe){(iframe=$(iframe)).attr("src",iframe.attr("src"))}))})),modal.find("object").length>0&&modal.find(Selector_closeBtn).click((function(e){var modal=$(e.currentTarget).closest(Selector_cmModal);modal.find("object").each((function(index,object){(object=$(object)).attr("data","")})),modalStore[modal.attr("data-cmid")]=void 0})),modal.find(Selector_moodleMediaPlayer).length>0&&(modal.find(Selector_closeBtn).click((function(){modal.find(Selector_moodleMediaPlayer).html("")})),modalStore[modal.attr("data-cmid")]=void 0)},resizeModal=function(modalRoot){modalRoot.find(Selector_modal).animate({"max-width":modalMinWidth()},"fast");var mediaPlayer=$(Selector_moodleMediaPlayer);mediaPlayer.find("div").each((function(index,child){$(child).css("max-width","")})),mediaPlayer.length>0&&stopAllVideosOnDismiss(modalRoot),modalRoot.find(Selector_iframe).each((function(index,iframe){var modal;0===(modal=modalRoot.find(Selector_modalDialog)).length&&(modal=modalRoot.find(Selector_modal));var iframeWidth=Math.min($(iframe).width(),win.width());iframeWidth>modal.width()-70&&(modal.animate({"max-width":Math.max(iframeWidth+70,modalMinWidth())},"fast"),modalRoot.find(Selector_modal).animate({"max-width":Math.max(iframeWidth+70,modalMinWidth())},"fast"));var iframeHeight=Math.min($(iframe).height(),win.height()),modalBody=modalRoot.find(Selector_modalBody);iframeHeight>modalBody.height()-70&&modalBody.animate({"min-height":Math.min(iframeHeight+70,win.height())+1},"fast"),stopAllVideosOnDismiss(modalRoot)}))};const modalHeightChangeWatcher=function(modalRoot,howManyChecks,duration){let oldHeight=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const iframe=modalRoot.find(Selector_modalBody);if(iframe){const newHeight=Math.round(iframe.height());newHeight&&newHeight>oldHeight+10&&resizeModal(modalRoot),howManyChecks>0&&setTimeout((()=>{modalHeightChangeWatcher(modalRoot,howManyChecks-1,duration,newHeight)}),duration)}};return{init:function(courseIdInit,isEditing){courseId=courseIdInit,$(document).ready((function(){var modalSelectors=Object.keys(LaunchModalDataActions).map((function(key){return'[data-action="'+LaunchModalDataActions[key]+'"]'})).join(", "),pageContent=$(Selector_pageContent);0===pageContent.length&&(pageContent=$(Selector_regionMain)),pageContent.on("click",modalSelectors,(function(e){e.preventDefault();var tgt=$(e.currentTarget),clickedCmObject=tgt.closest("li.activity");clickedCmObject.hasClass("completeonview")&&require(["format_tiles/completion"],(function(completion){completion.triggerCompletionChangedEvent(clickedCmObject.closest(Selector_sectionMain).attr("data-section"))}));var existingModal=modalStore[clickedCmObject.attr("data-cmid")];if("object"==typeof existingModal)existingModal.show();else{switch(tgt.attr("data-action")){case LaunchModalDataActions.launchModuleModal:!function(clickedCmObject){var cmid=clickedCmObject.attr("data-cmid"),methodName="format_tiles_get_mod_"+clickedCmObject.attr("data-modtype")+"_html";modalFactory.create({type:modalFactory.types.DEFAULT,title:clickedCmObject.attr("data-title"),body:loadingIconHtml}).done((function(modal){modalStore[cmid]=modal,modal.setLarge(),modal.show();var modalRoot=$(modal.root);modalRoot.attr("data-cmid",cmid),modalRoot.attr("id","embed_mod_modal_"+cmid),modalRoot.addClass("embed_cm_modal"),modalRoot.addClass("mod_"+clickedCmObject.attr("data-modtype")),stopAllVideosOnDismiss(modalRoot),ajax.call([{methodname:methodName,args:{courseid:courseId,cmid:cmid}}])[0].done((function(response){const sectionNum=clickedCmObject.closest(Selector_sectionMain).attr("data-section");var templateData={cmid:cmid,modtitle:clickedCmObject.attr("data-title"),tileid:sectionNum,content:response.html};const checkBox=clickedCmObject.find(Selector_completioncheckbox);return 0!==checkBox.length&&(templateData.completionstate=clickedCmObject.hasClass(CLASS_COMPLETION_AUTO)?1:parseInt(checkBox.attr("data-completionstate")),templateData.completionInUseForCm=1,templateData.completionicon=1===templateData.completionstate?"y":"n",templateData.completionstateInverse=1-templateData.completionstate,templateData.completionIsManual=clickedCmObject.hasClass(CLASS_COMPLETION_MANUAL),templateData.completionstring=checkBox.attr("title"),require(["format_tiles/completion"],(function(completion){completion.triggerCompletionChangedEvent(sectionNum)}))),modal.setBody(templateData.content),Templates.render("format_tiles/embed_module_modal_header_btns",templateData).done((function(html){modalRoot.find(Selector_modalHeader).append(html),modalRoot.find(Selector_closeBtn).detach().appendTo(modalRoot.find(Selector_embedModuleButtons))})).fail(Notification.exception),setTimeout((()=>{modalHeightChangeWatcher(modalRoot,3,1e3)}),500),!0})).fail((function(ex){!0!==config.developerdebug?window.location=config.wwwroot+"/mod/"+clickedCmObject.attr("data-modtype")+"/view.php?id="+cmid:Notification.exception(ex)}))}))}(clickedCmObject);break;case LaunchModalDataActions.launchResourceModal:!function(clickedCmObject){var cmid=clickedCmObject.attr("data-cmid");modalFactory.create({type:modalFactory.types.DEFAULT,title:clickedCmObject.attr("data-title"),body:loadingIconHtml}).done((function(modal){modalStore[cmid]=modal,modal.setLarge(),modal.show();var modalRoot=$(modal.root);modalRoot.attr("id","embed_mod_modal_"+cmid),modalRoot.attr("data-cmid",cmid),modalRoot.addClass("embed_cm_modal");const sectionNum=clickedCmObject.closest(Selector_sectionMain).attr("data-section");var templateData={id:cmid,pluginfileUrl:clickedCmObject.attr("data-url"),objectType:"text/html",width:"100%",height:Math.round(win.height()-60),cmid:cmid,tileid:sectionNum,isediting:0,sesskey:config.sesskey,modtitle:clickedCmObject.attr("data-title"),config:{wwwroot:config.wwwroot},showDownload:0,showNewWindow:0,completionInUseForCm:0,completionstring:""};"resource_pdf"===clickedCmObject.attr("data-modtype")&&(templateData.objectType="application/pdf",templateData.showDownload=1,templateData.showNewWindow=1),Templates.render("format_tiles/embed_file_modal_body",templateData).done((function(html){modal.setBody(html),modalRoot.find(Selector_modalBody).animate({"min-height":Math.round(win.height()-60)},"fast"),"resource_html"===clickedCmObject.attr("data-modtype")?(modalRoot.find(Selector_modal).animate({"max-width":"100%"},"fast"),modalRoot.find(Selector_modalDialog).animate({"max-width":"100%"},"fast"),modalRoot.find(Selector_modalBody).animate({"max-width":"100%"},"fast"),stopAllVideosOnDismiss(modalRoot)):(modalRoot.find(Selector_modal).animate({"max-width":modalMinWidth()},"fast"),modalRoot.find(Selector_modalDialog).animate({"max-width":modalMinWidth()},"fast"))})).fail(Notification.exception);const checkBox=clickedCmObject.find(Selector_completioncheckbox);return 0!==checkBox.length&&(templateData.completionstate=clickedCmObject.hasClass(CLASS_COMPLETION_AUTO)?1:parseInt(checkBox.attr("data-completionstate")),templateData.completionInUseForCm=1,templateData.completionicon=1===templateData.completionstate?"y":"n",templateData.completionstateInverse=1-templateData.completionstate,templateData.completionIsManual=clickedCmObject.hasClass(CLASS_COMPLETION_MANUAL),templateData.completionstring=checkBox.attr("title"),require(["format_tiles/completion"],(function(completion){completion.triggerCompletionChangedEvent(sectionNum)}))),Templates.render("format_tiles/embed_module_modal_header_btns",templateData).done((function(html){modalRoot.find(Selector_modalHeader).append(html),modalRoot.find(Selector_closeBtn).detach().appendTo(modalRoot.find(Selector_embedModuleButtons))})).fail(Notification.exception),!0}))}(clickedCmObject);break;case LaunchModalDataActions.launchUrlModal:!function(clickedCmObject){var cmid=clickedCmObject.attr("data-cmid");modalFactory.create({type:modalFactory.types.DEFAULT,title:clickedCmObject.attr("data-title"),body:loadingIconHtml}).done((function(modal){modalStore[cmid]=modal,modal.setLarge(),modal.show();var modalRoot=$(modal.root);modalRoot.attr("id","embed_mod_modal_"+cmid),modalRoot.attr("data-cmid",cmid),modalRoot.addClass("embed_cm_modal");var modalWidth=Math.round(.9*win.width()),modalHeight=Math.round(.9*win.height());const sectionNum=clickedCmObject.closest(Selector_sectionMain).attr("data-section");var templateData={id:cmid,pluginfileUrl:clickedCmObject.attr("data-url"),objectType:"text/html",width:modalWidth-30,height:modalHeight-30,cmid:cmid,tileid:sectionNum,isediting:0,sesskey:config.sesskey,modtitle:clickedCmObject.attr("data-title"),config:{wwwroot:config.wwwroot},showDownload:0,showNewWindow:1,completionInUseForCm:0,secondaryurl:clickedCmObject.closest(Selector_ACTIVITY).attr("data-url-secondary")};Templates.render("format_tiles/embed_url_modal_body",templateData).done((function(html){modal.setBody(html),modalRoot.find(Selector_modalBody).animate({"min-height":modalHeight},"fast"),modalRoot.find(Selector_modal).animate({"max-width":modalWidth},"fast"),modalRoot.find(Selector_modalDialog).animate({"max-width":modalWidth},"fast"),modalRoot.find(Selector_modalBody).animate({"max-width":modalWidth},"fast"),stopAllVideosOnDismiss(modalRoot),modalRoot.find(Selector_modalBody).addClass("text-center")})).fail(Notification.exception);const checkBox=clickedCmObject.find(Selector_completioncheckbox);return 0!==checkBox.length&&(templateData.completionstate=clickedCmObject.hasClass(CLASS_COMPLETION_AUTO)?1:parseInt(checkBox.attr("data-completionstate")),templateData.completionInUseForCm=1,templateData.completionicon=1===templateData.completionstate?"y":"n",templateData.completionstateInverse=1-templateData.completionstate,templateData.completionIsManual=clickedCmObject.hasClass(CLASS_COMPLETION_MANUAL),templateData.completionstring=checkBox.attr("title"),require(["format_tiles/completion"],(function(completion){completion.triggerCompletionChangedEvent(sectionNum)}))),Templates.render("format_tiles/embed_module_modal_header_btns",templateData).done((function(html){modalRoot.find(Selector_modalHeader).append(html),modalRoot.find(Selector_closeBtn).detach().appendTo(modalRoot.find(Selector_embedModuleButtons))})).fail(Notification.exception),setTimeout((function(){modalRoot.find(Selector_newWindowButton).click((function(){modalStore[modalRoot.attr("data-cmid")].hide(),modalStore[modalRoot.attr("data-cmid")]=void 0,modalRoot.remove(),$(".modal-backdrop").not("#window-overlay").removeClass("show").addClass("hide")}))}),1e3),!0}))}(clickedCmObject);break;default:throw new Error("Unknown modal type "+tgt.attr("data-action"))}ajax.call([{methodname:"format_tiles_log_mod_view",args:{courseid:courseId,cmid:clickedCmObject.attr("data-cmid")}}])[0].fail(Notification.exception)}0!==clickedCmObject.find(Selector_completionAuto).length&&require(["format_tiles/completion"],(function(completion){completion.triggerCompletionChangedEvent(clickedCmObject.closest(Selector_sectionMain).attr("data-section"))}))})),Templates.render("format_tiles/loading",{}).catch(Notification.exception).done((function(html){loadingIconHtml=html})).fail(Notification.exception),isEditing||pageContent.on("click",Selector_URLACTIVITYPOPUPLINK,(function(e){!function(e){var clickedActivity=$(e.currentTarget).closest(Selector_ACTIVITY);void 0!==clickedActivity.attr("data-url")&&(e.stopPropagation(),e.preventDefault(),ajax.call([{methodname:"format_tiles_log_mod_view",args:{courseid:courseId,cmid:clickedActivity.attr("data-cmid")}}])[0].done((function(){require(["format_tiles/completion"],(function(completion){completion.markAsAutoCompleteInUI(courseId,clickedActivity)}));var newWin=window.open(clickedActivity.attr("data-url"));try{newWin.focus()}catch(e){var popUpLink='<div><a href="'+clickedActivity.attr("data-url")+'">'+clickedActivity.attr("data-url")+"</a></div>";require(["core/str","core/notification"],(function(Str,Notification){Str.get_strings([{key:"sectionerrortitle",component:"format_tiles"},{key:"blockedpopup",component:"format_tiles"},{key:"cancel"}]).done((function(s){Notification.alert(s[0],s[1]+popUpLink,s[2])}))}))}})).fail(Notification.exception))}(e)}))}))}}}));

//# sourceMappingURL=course_mod_modal.min.js.map